<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>User Panel - Test Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, sans-serif; }

        body { background-color: var(--bg); color: var(--text); padding-bottom: 80px; }

        /* HEADER: TELEGRAM STYLE */
        .tg-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: white;
            gap: 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        .avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 20px; object-fit: cover;
        }
        .user-meta h2 { font-size: 18px; font-weight: 800; color: #000; letter-spacing: 0.5px; }
        .user-meta p { font-size: 12px; color: var(--muted); }

        /* BLUE WALLET CARD (FROM SCREENSHOT) */
        .balance-card {
            margin: 15px 20px;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            border-radius: 20px;
            padding: 25px;
            color: white;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
        }
        .balance-card span { font-size: 14px; opacity: 0.9; }
        .balance-card h1 { font-size: 38px; margin: 8px 0 20px; font-weight: 700; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn-action {
            flex: 1; padding: 12px; border-radius: 12px; border: none;
            background: rgba(255, 255, 255, 0.2); color: white;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
        }

        /* QUICK STATS (GRID VIEW) */
        .stats-section { background: white; margin: 15px 20px; border-radius: 20px; padding: 15px; }
        .stats-title { font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card {
            background: var(--bg); border-radius: 15px; padding: 20px 10px; text-align: center;
        }
        .stat-card h3 { color: var(--primary); font-size: 22px; margin-bottom: 4px; }
        .stat-card p { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 600; }

        /* TAB MANAGEMENT */
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }

        /* TASK LISTING */
        .task-card {
            background: white; margin: 0 20px 12px; padding: 16px;
            border-radius: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .task-info h4 { font-size: 15px; margin-bottom: 4px; }
        .task-info span { font-size: 13px; color: #16a34a; font-weight: 700; }
        .btn-claim { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; }

        /* BOTTOM NAVIGATION */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            border-top: 1px solid #f1f5f9; z-index: 1000;
        }
        .nav-item {
            background: none; border: none; color: var(--muted);
            display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: 500;
        }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; }

        /* FORMS */
        .input-group { padding: 0 20px; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 13px; margin-bottom: 6px; font-weight: 600; color: var(--muted); }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; background: white; }
        .btn-main { margin: 10px 20px; width: calc(100% - 40px); background: var(--primary); color: white; padding: 16px; border-radius: 15px; border: none; font-weight: 700; font-size: 16px; }

        #announcement-box {
            margin: 10px 20px; padding: 12px; background: #dbeafe; border-radius: 10px;
            color: var(--primary); font-size: 13px; font-weight: 500; display: none;
        }
    </style>
</head>
<body>

    <header class="tg-header">
        <img id="header-pic" class="avatar" src="" alt="?">
        <div class="user-meta">
            <h2 id="header-name">LOADING...</h2>
            <p id="header-id">ID: 000000000</p>
        </div>
    </header>

    <div id="announcement-box"></div>

    <main>
        <section id="dashboard" class="tab-content active">
            <div class="balance-card">
                <span>Available Balance</span>
                <h1 id="dash-bal">‚Çπ0.00</h1>
                <div class="btn-group">
                    <button class="btn-action" onclick="showTab('withdraw')">‚Üë Withdraw</button>
                    <button class="btn-action" onclick="showTab('tasks')">‚Üì Deposit</button>
                </div>
            </div>

            <div class="stats-section">
                <div class="stats-title">üìä Quick Stats</div>
                <div class="stats-grid">
                    <div class="stat-card"><h3 id="stat-dep">‚Çπ0</h3><p>Total Deposit</p></div>
                    <div class="stat-card"><h3 id="stat-wit">‚Çπ0</h3><p>Total Withdraw</p></div>
                    <div class="stat-card"><h3 id="stat-ref">0</h3><p>Referrals</p></div>
                    <div class="stat-card"><h3 id="stat-tsk">0</h3><p>Tasks Done</p></div>
                </div>
            </div>
            
            <div class="stats-title" style="margin-left: 20px;">üî• Top Tasks</div>
            <div id="quick-tasks"></div>
        </section>

        <section id="tasks" class="tab-content">
            <div class="stats-title" style="margin: 10px 20px;">üìã All Tasks</div>
            <div id="full-task-list"></div>
        </section>

        <section id="withdraw" class="tab-content">
            <div class="stats-title" style="margin: 10px 20px;">üí∞ Withdraw Funds</div>
            <div class="input-group">
                <label>UPI ID</label>
                <input type="text" id="upi-id" placeholder="example@ybl">
            </div>
            <div class="input-group">
                <label>Amount (‚Çπ)</label>
                <input type="number" id="w-amount" placeholder="Min ‚Çπ100">
            </div>
            <button class="btn-main" onclick="requestWithdrawal()">Submit Request</button>
            <div class="stats-title" style="margin: 20px;">Recent Withdrawals</div>
            <div id="withdraw-history"></div>
        </section>

        <section id="profile" class="tab-content">
            <div class="stats-section">
                <div class="stats-title">üë§ My Profile</div>
                <p style="padding: 5px 0;"><strong>Referral Link:</strong></p>
                <input type="text" id="ref-link-field" readonly style="margin-bottom: 10px; font-size: 12px; background: #f1f5f9;">
                <button class="btn-main" style="margin:0; width:100%;" onclick="copyRef()">Copy Referral Link</button>
                <div style="margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 15px;">
                    <p>Referrer: <span id="p-refby">None</span></p>
                </div>
            </div>
        </section>
    </main>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="showTab('dashboard')"><i>üè†</i>Home</button>
        <button class="nav-item" onclick="showTab('tasks')"><i>üìã</i>Tasks</button>
        <button class="nav-item" onclick="showTab('withdraw')"><i>üí∞</i>Withdraw</button>
        <button class="nav-item" onclick="showTab('profile')"><i>üë§</i>Profile</button>
    </nav>

    <script>
        // FIREBASE CONNECT
        const firebaseConfig = {
            apiKey: "AIzaSyDZwLLI4Ske7m4Ch1FI8jniU0Ayor8LVRM",
            authDomain: "telegram-mini-6932e.firebaseapp.com",
            projectId: "telegram-mini-6932e",
            storageBucket: "telegram-mini-6932e.firebasestorage.app",
            messagingSenderId: "1007549666090",
            appId: "1:1007549666090:web:84af388b9d6f2798430453"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe.user || { id: 8021307643, first_name: "A S H", photo_url: "" };
        const BOT_USER = "YOUR_BOT_USERNAME"; // Replace with your bot username

        let userData = {};

        function init() {
            tg.expand();
            syncUser();
            fetchAnnouncements();
            fetchTasks();
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function syncUser() {
            const userRef = db.collection('users').doc(user.id.toString());
            userRef.onSnapshot(doc => {
                if (doc.exists) {
                    userData = doc.data();
                    renderUI();
                } else {
                    const startParam = tg.initDataUnsafe.start_param;
                    userRef.set({
                        id: user.id, name: user.first_name, photoURL: user.photo_url || "",
                        coins: 0, reffer: 0, refferBy: startParam || null, 
                        tasksCompleted: 0, totalWithdrawals: 0
                    });
                }
            });
        }

        function renderUI() {
            document.getElementById('header-name').innerText = userData.name.toUpperCase();
            document.getElementById('header-id').innerText = `ID: ${userData.id}`;
            document.getElementById('header-pic').src = userData.photoURL || `https://ui-avatars.com/api/?name=${userData.name}&background=2563eb&color=fff`;
            
            document.getElementById('dash-bal').innerText = `‚Çπ${userData.coins.toFixed(2)}`;
            document.getElementById('stat-wit').innerText = `‚Çπ${userData.totalWithdrawals}`;
            document.getElementById('stat-ref').innerText = userData.reffer;
            document.getElementById('stat-tsk').innerText = userData.tasksCompleted;
            document.getElementById('p-refby').innerText = userData.refferBy || "None";
            document.getElementById('ref-link-field').value = `https://t.me/${BOT_USER}?start=${user.id}`;
        }

        function fetchAnnouncements() {
            db.collection('announcements').orderBy('createdAt', 'desc').limit(1).onSnapshot(s => {
                if (!s.empty) {
                    const d = s.docs[0].data();
                    const box = document.getElementById('announcement-box');
                    box.innerText = `üîî ${d.title}`;
                    box.style.display = 'block';
                }
            });
        }

        function fetchTasks() {
            db.collection('tasks').onSnapshot(snap => {
                const tasks = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const html = tasks.map(t => `
                    <div class="task-card">
                        <div class="task-info">
                            <h4>${t.name}</h4>
                            <span>+‚Çπ${t.reward}</span>
                        </div>
                        <button class="btn-claim" onclick="claimTask('${t.id}', ${t.reward}, '${t.link}')">Claim</button>
                    </div>
                `).join('');
                document.getElementById('full-task-list').innerHTML = html;
                document.getElementById('quick-tasks').innerHTML = html.slice(0, 3);
            });
        }

        async function claimTask(tid, reward, link) {
            window.open(link, '_blank');
            const claimId = `${user.id}_${tid}`;
            const claimRef = db.collection('user_claims').doc(claimId);
            
            try {
                await db.runTransaction(async (t) => {
                    const doc = await t.get(claimRef);
                    if (doc.exists) throw "Already Claimed!";
                    t.set(claimRef, { userId: user.id, taskId: tid, claimedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    t.update(db.collection('users').doc(user.id.toString()), {
                        coins: firebase.firestore.FieldValue.increment(reward),
                        tasksCompleted: firebase.firestore.FieldValue.increment(1)
                    });
                });
                tg.showScanQrPopup({ text: "Reward added to wallet!" }); // Small trick to show feedback
            } catch (e) { tg.showAlert(e); }
        }

        async function requestWithdrawal() {
            const amount = parseFloat(document.getElementById('w-amount').value);
            const upi = document.getElementById('upi-id').value;
            if (amount < 100 || amount > userData.coins) return tg.showAlert("Check amount/balance (Min ‚Çπ100)");

            await db.collection('withdrawals').add({
                userId: user.id, amount, upi, status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('users').doc(user.id.toString()).update({
                coins: firebase.firestore.FieldValue.increment(-amount),
                totalWithdrawals: firebase.firestore.FieldValue.increment(amount)
            });
            tg.showAlert("Withdrawal Request Submitted!");
        }

        function copyRef() {
            const copyText = document.getElementById("ref-link-field");
            copyText.select();
            document.execCommand("copy");
            tg.showAlert("Referral link copied!");
        }

        init();
    </script>
</body>
</html>
